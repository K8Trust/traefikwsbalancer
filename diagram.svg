<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg width="800" height="600" xmlns="http://www.w3.org/2000/svg">
    <!-- Title -->
    <text x="400" y="30" font-family="Arial" font-size="20" text-anchor="middle" font-weight="bold">Traefik WebSocket Connection Balancer</text>
    
    <!-- Client -->
    <rect x="50" y="80" width="120" height="80" fill="#ffeeee" stroke="#000000" stroke-width="2" />
    <text x="110" y="110" font-family="Arial" font-size="14" text-anchor="middle" font-weight="bold">Client</text>
    <text x="110" y="130" font-family="Arial" font-size="12" text-anchor="middle">WebSocket Client</text>
    <text x="110" y="150" font-family="Arial" font-size="12" text-anchor="middle">Browser/App</text>
    
    <!-- Traefik -->
    <rect x="300" y="60" width="250" height="120" fill="#eeffee" stroke="#000000" stroke-width="2" />
    <text x="425" y="80" font-family="Arial" font-size="14" text-anchor="middle" font-weight="bold">Traefik Proxy</text>
    
    <!-- Balancer Middleware -->
    <rect x="320" y="95" width="210" height="70" fill="#eeeeff" stroke="#000000" stroke-width="2" />
    <text x="425" y="115" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">WebSocket Connection Balancer</text>
    <text x="425" y="135" font-family="Arial" font-size="10" text-anchor="middle">Middleware Plugin</text>
    <text x="425" y="155" font-family="Arial" font-size="10" text-anchor="middle">Routes to pod with lowest connections</text>
    
    <!-- Metrics -->
    <rect x="650" y="80" width="120" height="80" fill="#fff8ee" stroke="#000000" stroke-width="2" />
    <text x="710" y="110" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">Metrics Endpoint</text>
    <text x="710" y="130" font-family="Arial" font-size="10" text-anchor="middle">/balancer-metrics</text>
    
    <!-- Arrows for connection flow -->
    <line x1="170" y1="120" x2="300" y2="120" stroke="#666666" stroke-width="2" />
    <polygon points="295,115 300,120 295,125" fill="#666666" />
    <text x="235" y="110" font-family="Arial" font-size="10" text-anchor="middle">WebSocket</text>
    <text x="235" y="125" font-family="Arial" font-size="10" text-anchor="middle">Connection</text>
    
    <line x1="550" y1="120" x2="650" y2="120" stroke="#666666" stroke-width="2" />
    <polygon points="645,115 650,120 645,125" fill="#666666" />
    <text x="600" y="110" font-family="Arial" font-size="10" text-anchor="middle">JSON</text>
    <text x="600" y="125" font-family="Arial" font-size="10" text-anchor="middle">Metrics</text>
    
    <!-- Single Service Box -->
    <rect x="250" y="230" width="350" height="200" fill="#eeeeff" stroke="#000000" stroke-width="2" />
    <text x="425" y="250" font-family="Arial" font-size="14" text-anchor="middle" font-weight="bold">Single Kubernetes Service</text>
    <text x="425" y="270" font-family="Arial" font-size="10" text-anchor="middle">(e.g., kbrain-socket-agent-ktrust-service.phaedra.svc.cluster.local)</text>
    
    <!-- Pods in Service -->
    <rect x="280" y="290" width="80" height="80" fill="#ffffff" stroke="#000000" stroke-width="1" />
    <text x="320" y="315" font-family="Arial" font-size="10" text-anchor="middle" font-weight="bold">Pod 1</text>
    <text x="320" y="335" font-family="Arial" font-size="10" text-anchor="middle">5 connections</text>
    <text x="320" y="350" font-family="Arial" font-size="8" text-anchor="middle">100.68.32.4</text>
    
    <rect x="390" y="290" width="80" height="80" fill="#ffffff" stroke="#000000" stroke-width="1" stroke-width="3" stroke="#990000" />
    <text x="430" y="315" font-family="Arial" font-size="10" text-anchor="middle" font-weight="bold">Pod 2</text>
    <text x="430" y="335" font-family="Arial" font-size="10" text-anchor="middle">1 connection</text>
    <text x="430" y="350" font-family="Arial" font-size="8" text-anchor="middle">100.68.36.4</text>
    <text x="430" y="370" font-family="Arial" font-size="9" text-anchor="middle" fill="#990000">Selected (lowest)</text>
    
    <rect x="500" y="290" width="80" height="80" fill="#ffffff" stroke="#000000" stroke-width="1" />
    <text x="540" y="315" font-family="Arial" font-size="10" text-anchor="middle" font-weight="bold">Pod 3</text>
    <text x="540" y="335" font-family="Arial" font-size="10" text-anchor="middle">3 connections</text>
    <text x="540" y="350" font-family="Arial" font-size="8" text-anchor="middle">100.68.42.4</text>
    
    <!-- Direct connection to specific pod -->
    <line x1="425" y1="180" x2="425" y2="210" stroke="#666666" stroke-width="2" />
    <line x1="425" y1="210" x2="430" y2="290" stroke="#990000" stroke-width="3" />
    <polygon points="425,285 430,290 435,285" fill="#990000" />
    <text x="385" y="240" font-family="Arial" font-size="10" text-anchor="middle" font-weight="bold" fill="#990000">Direct connection</text>
    <text x="385" y="255" font-family="Arial" font-size="10" text-anchor="middle" font-weight="bold" fill="#990000">to specific pod</text>
    
    <!-- Metrics Collection from all pods -->
    <line x1="320" y1="370" x2="320" y2="430" stroke="#666666" stroke-width="1" />
    <line x1="430" y1="370" x2="430" y2="400" stroke="#666666" stroke-width="1" />
    <line x1="540" y1="370" x2="540" y2="430" stroke="#666666" stroke-width="1" />
    
    <line x1="320" y1="430" x2="540" y2="430" stroke="#666666" stroke-width="1" />
    <line x1="430" y1="400" x2="430" y2="430" stroke="#666666" stroke-width="1" />
    
    <!-- Connection Collection -->
    <rect x="250" y="460" width="350" height="80" fill="#fff0f0" stroke="#000000" stroke-width="2" />
    <text x="425" y="480" font-family="Arial" font-size="14" text-anchor="middle" font-weight="bold">Connection Count Collection</text>
    <text x="425" y="500" font-family="Arial" font-size="10" text-anchor="middle">1. Direct Pod Metrics via /metric endpoint</text>
    <text x="425" y="520" font-family="Arial" font-size="10" text-anchor="middle">2. Pod Discovery via IP Scanning (Â±5 3rd octet)</text>
    
    <!-- Pod Discovery -->
    <line x1="600" y1="490" x2="650" y2="490" stroke="#666666" stroke-width="1" />
    <polygon points="645,485 650,490 645,495" fill="#666666" />
    
    <rect x="650" y="450" width="130" height="100" fill="#f0fff0" stroke="#000000" stroke-width="2" />
    <text x="715" y="470" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">Pod Discovery</text>
    <text x="715" y="490" font-family="Arial" font-size="10" text-anchor="middle">Finds all pods across</text>
    <text x="715" y="505" font-family="Arial" font-size="10" text-anchor="middle">different subnets</text>
    <text x="715" y="525" font-family="Arial" font-size="10" text-anchor="middle">by varying 3rd octet</text>
    
    <!-- Footer -->
    <text x="400" y="570" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">Traefik plugin selects individual pod with lowest connections</text>
    <text x="400" y="585" font-family="Arial" font-size="10" text-anchor="middle">Connects directly to pod IP rather than letting Kubernetes handle service routing</text>
</svg> 